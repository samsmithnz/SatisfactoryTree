@page "/"

<PageTitle>Home</PageTitle>

@using SatisfactoryTree.Logic
@using SatisfactoryTree.Logic.Calculations
@using SatisfactoryTree.Logic.Extraction
@using SatisfactoryTree.Logic.Models
@using SatisfactoryTree.Web.Services
@inject HttpClient Http
@inject PlanService PlanService
@inject IJSRuntime JS
@implements IDisposable

@code {
	FactoryCatalog? factoryCatalog;
	private bool isLoading = true;
	private string? errorMessage;
	private int? factoryIdToScrollTo; // local cache for scrolling

	protected override async Task OnInitializedAsync()
	{
		try
		{
			factoryCatalog = await Http.GetFromJsonAsync<FactoryCatalog>("content/gameData.json");
			if (factoryCatalog == null)
			{
				throw new Exception("FactoryCatalog could not be loaded or found");
			}

			// Initialize the plan if it doesn't exist
			if (PlanService.Plan == null)
			{
				Plan plan = new();
				Calculator calculator = new();
				// Factory2? screwsFactory = new(1, "Screws factory");
				// screwsFactory.ExportedParts.Add(new(new() { Name = "IronScrew", Quantity = 12 }));
				// plan.Factories.Add(screwsFactory);
				Factory2? reinforcedPlatesFactory = new(1, "Reinforced Iron Plates factory", factoryCatalog);
				reinforcedPlatesFactory.AddIngredient("IronPlateReinforced", 5, Lookups.GetRecipes(factoryCatalog, "IronPlateReinforced").Find(r => r.Name == "IronPlateReinforced"));
				reinforcedPlatesFactory.AddIngredient("IronPlate", 30, Lookups.GetRecipes(factoryCatalog, "IronPlate").Find(r => r.Name == "IronPlate"));
				reinforcedPlatesFactory.AddIngredient("IronScrew", 30, Lookups.GetRecipes(factoryCatalog, "IronScrew").Find(r => r.Name == "Alternate_Screw"));
				calculator.ValidateFactoryIngredients(reinforcedPlatesFactory);
				plan.Factories.Add(reinforcedPlatesFactory);

				Factory2 ironPlatesFactory = new(1, "Iron Plates Factory", factoryCatalog);
				Recipe? ironPlatesRecipe = Lookups.GetRecipes(factoryCatalog, "IronPlate").Find(r => r.Name == "IronPlate");
				ironPlatesFactory.AddIngredient("IronPlate", 30, ironPlatesRecipe);
				calculator.ValidateFactoryIngredients(ironPlatesFactory);
				plan.Factories.Add(ironPlatesFactory);

				Factory2 heavyModularFramesfactory = new(1, "Heavy Modular Frame Factory", factoryCatalog);
				Recipe? heavyModularFramesRecipe = Lookups.GetRecipes(factoryCatalog, "ModularFrameHeavy").Find(r => r.Name == "ModularFrameHeavy");
				heavyModularFramesfactory.AddIngredient("ModularFrameHeavy", 1, heavyModularFramesRecipe);
				calculator.ValidateFactoryIngredients(heavyModularFramesfactory);
				plan.Factories.Add(heavyModularFramesfactory);

				Factory2 plasticFactory = new(1, "Plastic Factory", factoryCatalog);
				Recipe? plasticRecipe = Lookups.GetRecipes(factoryCatalog, "Plastic").Find(r => r.Name == "Plastic");
				plasticFactory.AddIngredient("Plastic", 30, plasticRecipe);				
				calculator.ValidateFactoryIngredients(plasticFactory);
				plan.Factories.Add(plasticFactory);

				//Calculate the production
				//plan.UpdatePlanCalculations(factoryCatalog);

				// Update the PlanService so NavMenu can access the plan
				PlanService.Plan = plan;
			}
			else
			{
				// Recalculate if plan already exists (in case new factories were added)
				RecalculatePlan();
			}
        
			// Update the PlanService so NavMenu can access the plan
			PlanService.FactoryCatalog = factoryCatalog;

			isLoading = false;
		}
		catch (Exception ex)
		{
			errorMessage = ex.Message;
			isLoading = false;
		}
	}

	protected override void OnInitialized()
	{
		PlanService.PlanChanged += OnPlanChanged;
	}

	public void Dispose()
	{
		PlanService.PlanChanged -= OnPlanChanged;
	}

	private void OnPlanChanged()
	{
		// Capture last added factory ID (if any) before recalculation
		factoryIdToScrollTo = PlanService.LastAddedFactoryId;
		RecalculatePlan();
		InvokeAsync(StateHasChanged);
	}

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (factoryIdToScrollTo.HasValue && PlanService.Plan != null)
		{
			Factory2? factory = PlanService.Plan.Factories.FirstOrDefault(f => f.Id == factoryIdToScrollTo.Value);
			if (factory != null)
			{
				string anchor = GetFactoryAnchor(factory);
				try
				{
					await JS.InvokeVoidAsync("scrollToFactoryAnchor", anchor);
				}
				catch { /* ignore JS errors */ }
			}
			PlanService.ClearLastAddedFactory();
			factoryIdToScrollTo = null;
		}
	}

	private void RecalculatePlan()
	{
		if (PlanService.Plan != null && factoryCatalog != null)
		{
			PlanService.Plan.UpdatePlanCalculations(factoryCatalog);
		}
	}

	private string GetFactoryAnchor(Factory2 factory)
	{
		// Create a URL-friendly anchor from the factory name (same logic as NavMenu)
		return factory.Name.ToLowerInvariant()
			.Replace(" ", "-")
			.Replace("'", "")
			.Replace("&", "and")
			.Replace("/", "-")
			.Replace("\\", "-")
			.Replace("(", "")
			.Replace(")", "");
	}
}

@if (isLoading)
{
	<p>Loading...</p>
}
else if (!string.IsNullOrEmpty(errorMessage))
{
	<div class="alert alert-danger">
		<strong>Error:</strong> @errorMessage
	</div>
}
else if (PlanService.Plan?.Factories != null)
{
	<h3>The plan</h3>
	@foreach (Factory2 factory in PlanService.Plan.Factories)
	{
		<div id="@GetFactoryAnchor(factory)" class="factory-section">
			<FactoryItems Factory="factory" FactoryCatalog="factory.FactoryCatalog" />
		</div>
	}
}
else
{
	<p>No data available.</p>
}
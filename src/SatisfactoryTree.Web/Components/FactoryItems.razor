@using SatisfactoryTree.Logic.Models

@code {
    [Parameter]
    public Factory? Factory { get; set; }
    [Parameter]
    public Dictionary<string, Part>? Parts { get; set; }

    private void OnPartSelected(Part selectedPart, Item item)
    {
        item.Name = selectedPart.Name;
        StateHasChanged();
    }

    private Part? GetCurrentPart(Item item)
    {
        if (Parts == null) return null;
        Parts.TryGetValue(item.Name, out Part? part);
        return part;
    }

    private string GetPartImagePath(string partName)
    {
        // Handle special mapping cases where the part name doesn't directly match the image name
        string imageName = partName switch
        {
            "IronPlateReinforced" => "ReinforcedIronPlate",
            "OreIron" => "IronOre", 
            "IronScrew" => "IronScrews",
            _ => partName.Replace(" ", "") // Default: remove spaces
        };
        
        return $"images/parts/{imageName}_256.png";
    }

    private string GetBuildingImagePath(string buildingName)
    {
        // Handle building name mappings to match image files
        string imageName = buildingName switch
        {
            "smelter" => "SmelterMk1_256.png",
            "foundry" => "Foundry_256.png",
            "constructor" => "ConstructorMk1_256.png",
            "assembler" => "AssemblerMk1_256.png",
            "manufacturer" => "Manufacturer_256.png",
            "refinery" => "OilRefinery_256.png",
            "packager" => "Packager_256.png",
            "blender" => "Blender_256.png",
            "hadronCollider" => "ParticleAccelerator_256.png",
            "generatorcoal" => "CoalGenerator_256.png",
            "generatorfuel" => "FuelGenerator_256.png",
            "generatornuclear" => "NuclearPowerplant_256.png",
            "generatorbiomass" => "BiomassBurner_256.png",
            "generatorgeothermal" => "GeothermalPowerGenerator_256.png",
            "minermk1" => "MinerMk1_256.png",
            "minermk2" => "MinerMk2_256.png",
            "minermk3" => "MinerMk3_256.png",
            "oilpump" => "OilExtractor_256.png",
            "waterpump" => "WaterExtractor_256.png",
            "frackingextractor" => "ResourceWellExtractor_256.png",
            "frackingsmasher" => "ResourceWellPressurizer_256.png",
            "resourcesink" => "ResourceSink_256.png",
            _ => $"{buildingName}_256.png" // Default: use building name as-is
        };
        
        return $"images/buildings/{imageName}";
    }
}

<div class="factory-container">
    <p><b>Factory parts:</b></p>
    @if (Factory?.TargetParts != null && Factory.TargetParts.Any())
    {
        <ul>
            @foreach (Item item in Factory.TargetParts)
            {
                <li>
                    <img src="@GetPartImagePath(item.Name)" alt="@item.Name" class="part-image" />
                    <strong>@item.Name</strong> - Quantity: @item.Quantity
                </li>
            }
        </ul>

        <p><b>Component parts:</b></p>
        <ul>
            @if (Factory?.ComponentParts != null && Factory.ComponentParts.Any())
            {
                @foreach (var item in Factory.ComponentParts)
                {
                    <li>
                        <TypeaheadDropdown TItem="Part"
                                         Items="@(Parts?.Values)"
                                         DisplayNameSelector="@(part => part.Name)"
                                         IdSelector="@(part => part.Name)"
                                         SelectedItem="@GetCurrentPart(item)"
                                         SelectedItemChanged="@(part => OnPartSelected(part, item))"
                                         Placeholder="Search for parts..."
                                         CssClass="me-2">
                            <ItemTemplate Context="part">
                                <strong>@part.Name</strong>
                                @if (part.IsFluid)
                                {
                                    <span class="badge badge-fluid">Fluid</span>
                                }
                                @if (part.IsFicsmas)
                                {
                                    <span class="badge badge-ficsmas">FICSMAS</span>
                                }
                            </ItemTemplate>
                        </TypeaheadDropdown>
                        <img src="@GetPartImagePath(item.Name)" alt="@item.Name" class="part-image" />
                        <strong>@item.Name</strong> - Quantity: @item.Quantity - Building: 
                        <img src="@GetBuildingImagePath(item.Building)" alt="@item.Building" class="building-image" />
                        @item.Building x @item.BuildingQuantity
                    </li>
                }
            }
            else
            {
                <li>No component parts.</li>
            }
        </ul>

        <p><b>Imported parts:</b></p>
        <ul>
            @if (Factory?.ImportedParts != null && Factory.ImportedParts.Any())
            {
                @foreach (Item item in Factory.ImportedParts)
                {
                    <li>
                        <img src="@GetPartImagePath(item.Name)" alt="@item.Name" class="part-image" />
                        <strong>@item.Name</strong> - Quantity: @item.Quantity - from factory: TBD
                    </li>
                }
            }
            else
            {
                <li>No imported parts.</li>
            }
        </ul>
    }
    else
    {
        <p>No items in this factory.</p>
    }
</div>

<style>
    .factory-container {
        max-width: 800px;
        margin: 20px 0;
    }
    
    .me-2 {
        margin-right: 10px;
    }

    .part-image {
        width: 42px;
        height: 42px;
        margin-right: 8px;
        vertical-align: middle;
        border-radius: 4px;
        object-fit: cover;
    }

    .building-image {
        width: 42px;
        height: 42px;
        margin-left: 4px;
        margin-right: 4px;
        vertical-align: middle;
        border-radius: 4px;
        object-fit: cover;
        border: 1px solid #ddd;
    }
</style>